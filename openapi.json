{
  "openapi": "3.1.0",
  "info": {
    "title": "MSPro Legal — Upload & Links",
    "version": "1.3.3",
    "description": "Загрузка документов в Supabase (bucket legal), постановка в буфер, коммит в таблицу documents, создание публичных ссылок и быстрый поиск."
  },
  "servers": [
    {
      "url": "https://lmqhpvqhardpluneonul.supabase.co"
    }
  ],
  "components": {
    "securitySchemes": {
      "apiKey": {
        "type": "apiKey",
        "in": "header",
        "name": "apikey"
      }
    },
    "schemas": {
      "StageFileRef": {
        "type": "object",
        "properties": {
          "p_session_id": { "type": "string" },
          "p_original_name": { "type": "string" },
          "p_storage_src_path": {
            "type": "string",
            "description": "временный путь, например inbox/uuid.tmp"
          },
          "p_type": { "type": "string", "default": "file" },
          "p_case_hint": { "type": "string", "format": "uuid", "nullable": true },
          "p_content_preview": { "type": "string", "nullable": true }
        },
        "required": ["p_session_id", "p_original_name"]
      },
      "CommitSession": {
        "type": "object",
        "properties": {
          "p_session_id": { "type": "string" },
          "p_default_folder": { "type": "string", "default": "documents" }
        },
        "required": ["p_session_id"]
      },
      "FindDocsRequest": {
        "type": "object",
        "properties": {
          "p_query": { "type": "string", "nullable": true },
          "p_case_id": { "type": "string", "format": "uuid", "nullable": true },
          "p_days": { "type": "integer", "nullable": true },
          "p_limit": { "type": "integer", "default": 10 }
        }
      },
      "PublicLinkRequest": {
        "type": "object",
        "properties": { "p_path": { "type": "string" } },
        "required": ["p_path"]
      },
      "EmbedDocument": {
        "type": "object",
        "properties": {
          "p_doc_id": { "type": "string", "format": "uuid" },
          "p_text": { "type": "string" }
        },
        "required": ["p_doc_id", "p_text"]
      }
    }
  },
  "security": [{ "apiKey": [] }],
  "paths": {
    "/storage/v1/object/legal/{path}": {
      "post": {
        "summary": "Загрузить файл в bucket legal (multipart)",
        "operationId": "storage_upload_legal",
        "parameters": [
          {
            "name": "path",
            "in": "path",
            "required": true,
            "description": "куда положить: напр. inbox/{uuid}.pdf",
            "schema": { "type": "string" }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "file": { "type": "string", "format": "binary" }
                },
                "required": ["file"]
              }
            }
          }
        },
        "responses": { "200": { "description": "OK (загружено)" } }
      }
    },
    "/rest/v1/rpc/stage_file_ref": {
      "post": {
        "summary": "Поставить загруженный файл в буфер сессии",
        "operationId": "stage_file_ref",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/StageFileRef" }
            }
          }
        },
        "responses": { "200": { "description": "UUID буферной записи" } }
      }
    },
    "/rest/v1/rpc/commit_session": {
      "post": {
        "summary": "Коммит: перенос/метаданные/журнал/публичная ссылка",
        "operationId": "commit_session",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/CommitSession" }
            }
          }
        },
        "responses": {
          "200": { "description": "Список добавленных документов с public_url" }
        }
      }
    },
    "/rest/v1/rpc/find_documents": {
      "post": {
        "summary": "Поиск документов (с public_url)",
        "operationId": "find_documents",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/FindDocsRequest" }
            }
          }
        },
        "responses": { "200": { "description": "OK" } }
      }
    },
    "/rest/v1/rpc/public_link_by_path": {
      "post": {
        "summary": "Построить публичную ссылку по storage_path",
        "operationId": "public_link_by_path",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/PublicLinkRequest" }
            }
          }
        },
        "responses": { "200": { "description": "Строка URL" } }
      }
    },
    "/rest/v1/rpc/embed_document": {
      "post": {
        "summary": "Создать embedding документа (autoindex)",
        "operationId": "embed_document",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/EmbedDocument" }
            }
          }
        },
        "responses": { "200": { "description": "Embedding создан" } }
      }
    }
  }
}